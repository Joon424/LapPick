<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
  <title>직원_상품관리</title>
<th:block layout:fragment="css">
    <style>
      table { table-layout: fixed; }
      th, td { vertical-align: middle; padding: 8px; }

      .manage-btn {
        display: inline-block; padding: 5px 10px; font-size: 12px;
        text-align: center; text-decoration: none; color: #333;
        background-color: #fff; border: 1px solid #ccc; border-radius: 4px;
        cursor: pointer; margin: 0 2px; white-space: nowrap;
      }
      .manage-btn:hover { background-color: #f0f0f0; border-color: #bbb; }
      .pagination-container .page-btn {
        display: inline-block; min-width: 32px; padding: 6px 10px;
        font-size: 13px; font-weight: 500; text-align: center; text-decoration: none;
        color: #333; background-color: #fff; border: 1px solid #ddd;
        border-radius: 4px; cursor: pointer;
      }
      .pagination-container .page-btn:hover { background-color: #f5f5f5; }
      .pagination-container .page-btn.active {
        background-color: #333; color: #fff; border-color: #333; font-weight: bold;
      }
      
      .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; z-index: 1000; }
      
      .modal-content { 
        background-color: #fff; 
        padding: 30px 40px;
        border-radius: 8px; 
        width: 90%; 
        max-width: 560px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
      }
      
      #stockChangeModal form { margin: 0; }
      .close-btn { font-size: 2rem; font-weight: bold; color: #888; cursor: pointer; border: none; background: none; }
      
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
      .modal-header h3 { font-size: 1.8rem; font-weight: 600; margin: 0; }
      
      .modal-body p { margin: 0 0: 15px 0; font-size: 1.3rem; color: #555; }
      .modal-body .guide-text { font-size: 0.9rem; color: #666; margin-top: -10px; margin-bottom: 15px; }
      
      .modal-body p strong { font-size: 1.4rem; font-weight: 600; color: #007bff; }
      
      .modal-body input[type="number"],
      .modal-body textarea { 
        width: 100%; 
        box-sizing: border-box; 
        padding: 0 12px; 
        border: 1px solid #ccc; 
        border-radius: 4px; 
      }
      .modal-body input[type="number"] { height: 48px; font-size: 1.3rem; margin-bottom: 5px; }
      .modal-body textarea { min-height: 80px; font-size: 1rem; padding-top:10px; padding-bottom:10px; }
      
      .modal-footer { 
        display: flex; 
        gap: 12px;
        margin-top: 30px; 
      }
      .modal-footer .btnset {
        flex: 1;
        padding-top: 12px;
        padding-bottom: 12px;
        font-size: 1.1rem;
      }
            /* [추가] 재고 수량 색상 스타일 */
      .stock-positive { color: #2a45b4; }
      .stock-zero-negative { color: #d21818; }
    </style>
  </th:block>
</head>
<body>
<div layout:fragment="content">
  <main class="th-layout-main">
    <div class="basic-N23" data-bid="cE2cZu89X4e">
      <div class="contents-inner">
        <div class="contents-container container-md">

           <div class="textset" style="margin-bottom:14px;">
            <img class="imageset-img" src="/resources/images/img_basic_N23_1.png" alt="이미지">
            <h2 class="textset-tit">상품 관리</h2>
            <p class="textset-desc">상품의 추가, 수정, 삭제를 관리하며, 상품 정보와 재고 상태를 업데이트하는 페이지입니다.</p>
            <div class="alert" th:if="${message}" th:text="${message}" style="background:#e0f7fa;color:#00796b;border:1px solid #b2ebf2;padding:10px 12px;border-radius:6px;margin-top:10px;"></div>
            <div class="alert" th:if="${error}" th:text="${error}" style="background:#ffebee;color:#c62828;border:1px solid #ef9a9a;padding:10px 12px;border-radius:6px;margin-top:10px;"></div>
          </div>

          <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:10px 0 16px;">
            <form th:action="@{/goods/list}" method="get" style="display:flex; gap:8px; align-items:center;">
              <input type="text" name="searchWord" th:value="${filter?.searchWord}" placeholder="상품명 또는 상품번호 검색" style="height:36px; padding:0 10px; border:1px solid #cbd5e1; border-radius:6px; min-width:240px;">
              <button type="submit" class="btnset btnset-line btnset-round">검색</button>
              <a class="btnset btnset-line btnset-round" th:href="@{/goods/list}">전체보기</a>
            </form>
            <div style="display:flex; gap:8px;">
              <a class="btnset btnset-line btnset-round" th:href="@{/goods/add}">상품등록</a>
              <button type="button" class="btnset btnset-line btnset-round" onclick="submitBulkDelete()">선택삭제</button>
            </div>
          </div>

          <form id="bulkDeleteForm" th:action="@{/goods/delete}" method="post">
          <table border="1" width="100%" style="border-collapse:collapse; border-color:#eee;">
              <thead>
                <tr style="background:#f9fafb;">
                  <th width="48" style="text-align:center;"><input type="checkbox" id="checkAll" onclick="toggleAll(this)"></th>
                  <th width="80" style="text-align:center; padding-left: 10px;">번호</th>
                  <th width="12%" style="padding-left: 30px;">상품번호</th>
                  <th style="padding-left: 50px;">상품명</th>
                  <th width="10%" style="text-align:center; padding-left: 40px;">현재고</th>
                  <th width="12%" style="text-align:left; padding-left: 40px;">가격</th>
                  <th width="12%" style="text-align:left; padding-left: 40px;">등록일</th>
                  <th width="18%" style="text-align:center;">관리</th>
                </tr>
              </thead>
              <tbody>
                <tr th:if="${#lists.isEmpty(goodsList)}">
                  <td colspan="8" style="text-align:center; padding:20px; color:#666;">표시할 상품이 없습니다.</td>
                </tr>
                <tr th:each="goods, stat : ${goodsList}">
                  <td style="text-align:center;"><input type="checkbox" name="nums" th:value="${goods.goodsNum}"></td>
                  <td style="text-align:center; padding-left: 10px;" th:text="${(pageData.page - 1) * pageData.size + stat.count}"></td>
                  <td style="padding-left: 30px;" th:text="${goods.goodsNum}"></td>
                  <td style="padding-left: 50px;" th:text="${goods.goodsName}"></td>
                  <td style="text-align:center; padding-left: 40px;">
                    <span th:text="${goods.stockQty}"
                          th:classappend="${goods.stockQty > 0} ? 'stock-positive' : 'stock-zero-negative'">
                    </span>
                  </td>
                  <td style="text-align:left; padding-left: 40px;" th:text="${#numbers.formatInteger(goods.goodsPrice, 0, 'COMMA')} + '원'"></td>
                  <td style="text-align:left; padding-left: 40px;" th:text="${#dates.format(goods.goodsDate, 'yyyy-MM-dd')}"></td>
                  <td style="text-align:center;">
                    <div style="display: flex; justify-content: center; align-items: center; gap: 4px;">
                      <button type="button" class="manage-btn" 
                              th:data-goods-num="${goods.goodsNum}"
                              th:data-goods-name="${goods.goodsName}"
                              onclick="openStockChangeModal(this)">재고</button>
                      <a class="manage-btn" th:href="@{/goods/{num}(num=${goods.goodsNum})}">상세</a>
                      <a class="manage-btn" th:href="@{/goods/{num}/edit(num=${goods.goodsNum})}">수정</a>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </form>
          
          <div class="pagination-container" style="display:flex; gap:6px; justify-content:center; align-items:center; margin-top:20px;"
               th:if="${pageData != null and pageData.total > 0 and pageData.startPage != null and pageData.endPage != null}">
            <a class="page-btn" th:href="@{/goods/list(page=${pageData.startPage - 1}, searchWord=${filter?.searchWord})}" th:if="${pageData.hasPrev}">이전</a>
            <a class="page-btn" th:each="i : ${#numbers.sequence(pageData.startPage, pageData.endPage)}" th:text="${i}"
               th:classappend="${pageData.page == i} ? 'active' : ''"
               th:href="@{/goods/list(page=${i}, searchWord=${filter?.searchWord})}"></a>
            <a class="page-btn" th:href="@{/goods/list(page=${pageData.endPage + 1}, searchWord=${filter?.searchWord})}" th:if="${pageData.hasNext}">다음</a>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <div id="stockChangeModal" class="modal-overlay">
    <div class="modal-content">
      <form id="stockChangeForm" th:action="@{/goods/stock-change}" method="post" onsubmit="return validateStockChange();">
        <div class="modal-header">
          <h3>재고 변경</h3>
          <button type="button" class="close-btn" onclick="closeStockChangeModal()">×</button>
        </div>
        <div class="modal-body">
          <p>상품명: <strong id="modalGoodsName"></strong></p>
          <input type="hidden" id="modalGoodsNum" name="goodsNum" />
          
          <input type="number" name="quantity" id="modalQuantity" placeholder="변경 수량 (예: 10 또는 -10)" required />
          <p class="guide-text">입고는 양수(+), 출고/차감은 음수(-)로 입력하세요.</p>

          <textarea name="memo" id="modalMemo" placeholder="변경 사유 (재고 차감 시 필수)"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btnset btnset-line" onclick="closeStockChangeModal()">취소</button>
          <button type="submit" class="btnset">변경 처리</button>
        </div>
      </form>
    </div>
  </div>

<th:block layout:fragment="script">
  <script>
    function toggleAll(master) {
      document.querySelectorAll('input[name="nums"]').forEach(cb => cb.checked = master.checked);
    }
    function submitBulkDelete() {
      const checked = document.querySelectorAll('input[name="nums"]:checked');
      if (checked.length === 0) {
        alert('삭제할 상품을 선택하세요.'); return;
      }
      if (confirm('선택한 ' + checked.length + '개의 상품을 삭제하시겠습니까?')) {
        document.getElementById('bulkDeleteForm').submit();
      }
    }

    const stockChangeModal = document.getElementById('stockChangeModal');
    const quantityInput = document.getElementById('modalQuantity');
    const memoInput = document.getElementById('modalMemo');

    function openStockChangeModal(button) {
      const goodsNum = button.dataset.goodsNum;
      const goodsName = button.dataset.goodsName;

      document.getElementById('modalGoodsNum').value = goodsNum;
      document.getElementById('modalGoodsName').textContent = goodsName;
      
      quantityInput.value = '';
      memoInput.value = '';
      
      stockChangeModal.style.display = 'flex';
      quantityInput.focus();
    }

    function closeStockChangeModal() {
      stockChangeModal.style.display = 'none';
    }

    function validateStockChange() {
      const quantityValue = quantityInput.value;
      
      if (isNaN(quantityValue) || quantityValue.trim() === '') {
        alert('변경 수량을 숫자로 입력해주세요.');
        quantityInput.focus();
        return false;
      }
      
      const quantity = parseInt(quantityValue, 10);
      const memo = memoInput.value.trim();

      if (quantity === 0) {
        alert('변경 수량은 0이 될 수 없습니다.');
        quantityInput.focus();
        return false;
      }
      
      if (quantity < 0 && memo === '') {
        alert('재고를 차감하는 경우, 변경 사유를 반드시 입력해야 합니다.');
        memoInput.focus();
        return false;
      }

      return true;
    }
  </script>
</th:block>
</body>
</html>