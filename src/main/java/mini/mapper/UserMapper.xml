<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mini.mapper.UserMapper">

    <!-- 회원 번호 생성 SQL -->
    <sql id="memberNum">
        SELECT CONCAT('mem_', 
                      COALESCE(CAST(SUBSTR(MAX(member_num), 5) AS INTEGER), 100000) + 1) 
        FROM members
    </sql>

    <!-- 회원 정보 삽입 SQL -->
    <insert id="userInsert" parameterType="memberDTO">
        <!-- 먼저 member_num을 조회 -->
        <selectKey keyProperty="memberNum" resultType="String" order="BEFORE">
            SELECT CONCAT('mem_', 
                          COALESCE(CAST(SUBSTR(MAX(member_num), 5) AS INTEGER), 100000) + 1) 
            FROM members
        </selectKey>

        <!-- 회원 정보 삽입 -->
        INSERT INTO members(
            MEMBER_NUM, MEMBER_NAME, MEMBER_ID, MEMBER_PW, MEMBER_ADDR,
            MEMBER_ADDR_DETAIL, MEMBER_POST, MEMBER_REGIST, GENDER,
            MEMBER_PHONE1, MEMBER_PHONE2, MEMBER_EMAIL, MEMBER_BIRTH,
            MEMBER_POINT, MEMBER_EMAIL_CONF
        )
        VALUES (
            #{memberNum}, #{memberName}, #{memberId}, #{memberPw}, #{memberAddr},
            #{memberAddrDetail}, #{memberPost}, SYSDATE, #{gender},
            #{memberPhone1}, #{memberPhone2}, #{memberEmail}, #{memberBirth},
            0, NULL
        )
    </insert>

</mapper>
