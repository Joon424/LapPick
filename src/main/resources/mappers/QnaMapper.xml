<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mini.mapper.QnaMapper">

    <resultMap id="qnaResultMap" type="mini.domain.QnaDTO">
        <id property="qnaNum" column="QNA_NUM"/>
        <result property="memberNum" column="MEMBER_NUM"/>
        <result property="goodsNum" column="GOODS_NUM"/>
        <result property="qnaType" column="QNA_TYPE"/>
        <result property="qnaTitle" column="QNA_TITLE"/>
        <result property="qnaContent" column="QNA_CONTENT"/>
        <result property="qnaDate" column="QNA_DATE"/>
        <result property="answerContent" column="ANSWER_CONTENT"/>
        <result property="answerDate" column="ANSWER_DATE"/>
        <result property="qnaStatus" column="QNA_STATUS"/>
        <association property="goodsDTO" javaType="mini.domain.GoodsDTO">
            <result property="goodsName" column="GOODS_NAME"/>
        </association>
        <association property="memberDTO" javaType="mini.domain.MemberDTO">
            <result property="memberId" column="MEMBER_ID"/>
        </association>
    </resultMap>

    <insert id="insertQna" parameterType="mini.domain.QnaDTO">
        INSERT INTO QNA (
            QNA_NUM, MEMBER_NUM, GOODS_NUM, QNA_TYPE, QNA_TITLE, QNA_CONTENT
        ) VALUES (
            QNA_SEQ.NEXTVAL, #{memberNum}, #{goodsNum}, #{qnaType}, #{qnaTitle}, #{qnaContent}
        )
    </insert>

    <select id="selectQnaByGoodsNum" parameterType="string" resultMap="qnaResultMap">
        SELECT Q.*, M.MEMBER_ID
        FROM QNA Q
        JOIN MEMBERS M ON Q.MEMBER_NUM = M.MEMBER_NUM
        WHERE Q.GOODS_NUM = #{goodsNum}
        ORDER BY Q.QNA_DATE DESC
    </select>

<select id="selectQnaByMemberNum" parameterType="map" resultMap="qnaResultMap">
    SELECT * FROM (
        SELECT ROWNUM AS RN, T.*
        FROM (
            SELECT 
                Q.*, 
                G.GOODS_NAME,
                M.MEMBER_ID FROM QNA Q
            JOIN GOODS G ON Q.GOODS_NUM = G.GOODS_NUM
            JOIN MEMBERS M ON Q.MEMBER_NUM = M.MEMBER_NUM WHERE Q.MEMBER_NUM = #{memberNum}
            <if test="status != null and status != ''">
                AND Q.QNA_STATUS = #{status}
            </if>
            <if test="searchWord != null and searchWord != ''">
                AND Q.QNA_TITLE LIKE '%' || #{searchWord} || '%'
            </if>
            ORDER BY Q.QNA_DATE DESC
        ) T
    )
    WHERE RN BETWEEN #{startRow} AND #{endRow}
</select>

<select id="countMyQna" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM QNA
    WHERE MEMBER_NUM = #{memberNum}
    <if test="status != null and status != ''">
        AND QNA_STATUS = #{status}
    </if>
    <if test="searchWord != null and searchWord != ''">
        AND QNA_TITLE LIKE '%' || #{searchWord} || '%'
    </if>
</select>

<select id="selectAllQna" parameterType="map" resultMap="qnaResultMap">
    SELECT * FROM (
        SELECT ROWNUM AS RN, T.*
        FROM (
            SELECT Q.*, G.GOODS_NAME, M.MEMBER_ID
            FROM QNA Q
            JOIN GOODS G ON Q.GOODS_NUM = G.GOODS_NUM
            JOIN MEMBERS M ON Q.MEMBER_NUM = M.MEMBER_NUM
            <where>
                <if test="status != null and status != ''">
                    AND Q.QNA_STATUS = #{status}
                </if>
                <if test="searchWord != null and searchWord != ''">
                    AND (Q.QNA_TITLE LIKE '%' || #{searchWord} || '%'
                    OR G.GOODS_NAME LIKE '%' || #{searchWord} || '%'
                    OR M.MEMBER_ID LIKE '%' || #{searchWord} || '%')
                </if>
            </where>
            ORDER BY Q.QNA_STATUS ASC, Q.QNA_DATE DESC
        ) T
    )
    WHERE RN BETWEEN #{startRow} AND #{endRow}
</select>

<select id="countAllQna" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM QNA Q
    JOIN GOODS G ON Q.GOODS_NUM = G.GOODS_NUM
    JOIN MEMBERS M ON Q.MEMBER_NUM = M.MEMBER_NUM
    <where>
        <if test="status != null and status != ''">
            AND Q.QNA_STATUS = #{status}
        </if>
        <if test="searchWord != null and searchWord != ''">
            AND (Q.QNA_TITLE LIKE '%' || #{searchWord} || '%'
            OR G.GOODS_NAME LIKE '%' || #{searchWord} || '%'
            OR M.MEMBER_ID LIKE '%' || #{searchWord} || '%')
        </if>
    </where>
</select>

<update id="updateAnswer" parameterType="mini.domain.QnaDTO">
    UPDATE QNA
    SET
        ANSWER_CONTENT = #{answerContent},
        ANSWER_DATE = SYSDATE,
        QNA_STATUS = '답변완료'
    WHERE QNA_NUM = #{qnaNum}
</update>

</mapper>