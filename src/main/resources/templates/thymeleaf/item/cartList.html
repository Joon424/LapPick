<!DOCTYPE html>
<html lang="ko" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
  <title>장바구니</title>
  
  <th:block layout:fragment="css">
    <style>
        /* 테이블 기본 스타일 */
        .cart-table {
            width: 100%;
            border-collapse: collapse;
            border-top: 2px solid #333;
            font-size: 14px;
        }
        .cart-table th, .cart-table td {
            padding: 15px 10px;
            vertical-align: middle;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
        }
        .cart-table th {
            background-color: #fafafa;
            font-weight: 600;
        }
        .empty-cart {
            padding: 80px 0;
            color: #777;
        }
        .td-image img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
        }
   /* [수정] 이 부분을 교체하세요 */
        .td-info {
            text-align: center;
            padding: 0 15px;
        }
        .goods-name {
            font-weight: 600;
            margin-bottom: 6px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 90px;
            margin: 0 auto;
        }
        .btn-qty {
            width: 30px;
            height: 30px;
            border: none;
            background: none;
            font-size: 18px;
            cursor: pointer;
            color: #555;
        }
        .qty-display {
            width: 30px;
            text-align: center;
            font-weight: 500;
        }
        .btn-delete {
            font-size: 13px;
            color: #888;
            text-decoration: none;
        }
        .btn-delete:hover { color: #f00; }
        .page-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
 /* [수정] 이 부분을 통째로 교체하세요 */
        .cart-summary {
            margin-top: 40px;
            padding: 25px 40px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: #fafafa;
            display: flex;
            justify-content: space-between; /* 왼쪽 그룹과 오른쪽 그룹을 양 끝으로 분리 */
            align-items: center;
        }
        .summary-group-left, .summary-group-right {
            display: flex;
            align-items: center;
            gap: 30px; /* 각 그룹 내 항목 간 간격 */
        }
        .summary-item { text-align: right; }
        .summary-item .label, .summary-item .value {
            font-size: 1.4rem;
        }
        .summary-item .label {
            color: #555;
        }
        .summary-item .value {
            font-weight: bold;
            color: #333;
        }
        .summary-item .value.price { color: #d63333; }

        /* ▼▼▼ 2. 구매하기 버튼 텍스트 크기 확대 ▼▼▼ */
        .btn-purchase {
            height: 55px; /* 높이 소폭 증가 */
            padding: 0 45px; /* 좌우 여백 소폭 증가 */
            font-size: 1.3rem; /* 폰트 크기 확대 */
            font-weight: 600;
            color: #fff;
            background-color: #333;
            border: 1px solid #333;
            border-radius: 6px;
            cursor: pointer;
        }
        /* ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲ */
        
        .btn-purchase:hover { background-color: #555; }
        .search-form {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .search-form input[type="text"] {
            height: 36px;
            padding: 0 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            min-width: 240px;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        .goods-name-link {
            text-decoration: none;
            color: inherit;
        }
        .goods-name-link:hover .goods-name {
            text-decoration: underline;
        }
        .goods-desc {
            color: #777;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
            /* [추가] 이 한 줄을 추가하여 가운데 정렬합니다. */
            margin: 6px auto 0;
        }
    </style>
  </th:block>
</head>
<div layout:fragment="content">
     <main class="th-layout-main">
      <div class="basic-N23" data-bid="Zk2czu8Wyib">
        <div class="contents-inner">
          <div class="contents-container container-md">
            
            <div class="textset" style="margin-bottom: 40px;">
              <img class="imageset-img" src="/resources/images/img_basic_N23_1.png" alt="이미지">
              <h2 class="textset-tit">장바구니</h2>
              <p class="textset-desc">선택하신 상품들을 한눈에 확인하고 수량을 조정하거나 구매할 수 있습니다.</p>
            </div>

            <div class="page-actions">
              <form class="search-form" th:action="@{/cart/cartList}" method="get">
                <input type="text" name="searchWord" th:value="${searchWord}" placeholder="상품명 검색">
                <button type="submit" class="btnset btnset-line btnset-round">검색</button>
                <a class="btnset btnset-line btnset-round" th:href="@{/cart/cartList}">전체보기</a>
              </form>
              <div class="action-buttons">
                  <button type="button" class="btnset btnset-line btnset-round" onclick="deleteSelectedItems()">선택 상품 삭제</button>
                  <button type="button" class="btnset btnset-line btnset-round" onclick="deleteAllItems()">전체삭제</button>
              </div>
            </div>

            <form action="/purchase/order" method="post" name="cartForm">
              <table class="cart-table">
                <thead>
                  <tr>
                    <th style="width: 5%;"><input type="checkbox" id="checkAll" checked></th>
                    <th style="width: 10%;">이미지</th>
                    <th style="width: 45%;">상품 이름</th>
                    <th style="width: 15%;">수량</th>
                    <th style="width: 15%;">상품금액</th>
                    <th style="width: 10%;">관리</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:if="${list == null or #lists.isEmpty(list)}">
                    <td colspan="6" class="empty-cart">
                      <span th:if="${searchWord == null or searchWord == ''}">장바구니에 담긴 상품이 없습니다.</span>
                      <span th:unless="${searchWord == null or searchWord == ''}">검색된 상품이 없습니다.</span>
                    </td>
                  </tr>
                  <tr th:each="dto : ${list}" class="cart-item">
                    <td class="td-check"><input type="checkbox" name="nums" checked th:value="${dto.goodsDTO.goodsNum}" class="item-check"></td>
                    <td class="td-image">
                      <a th:href="@{/corner/detailView/{num}(num=${dto.goodsDTO.goodsNum})}">
                        <img th:src="|/upload/${dto.goodsDTO.goodsMainStoreImage}|" alt="상품 이미지">
                      </a>
                    </td>
                    <td class="td-info">
                      <a th:href="@{/corner/detailView/{num}(num=${dto.goodsDTO.goodsNum})}" class="goods-name-link">
                        <p class="goods-name">[[${dto.goodsDTO.goodsName}]]</p>
                      </a>
                      <p class="goods-desc">[[${dto.goodsDTO.goodsContents}]]</p>
                    </td>
                    <td class="td-quantity">
                      <div class="quantity-control">
                        <button type="button" class="btn-qty minus" th:data-goods-num="${dto.goodsDTO.goodsNum}" th:data-goods-price="${dto.goodsDTO.goodsPrice}" onclick="handleQty('minus', this)">-</button>
                        <span class="qty-display" th:id="${dto.goodsDTO.goodsNum}">[[${dto.cartDTO.cartQty}]]</span>
                        <button type="button" class="btn-qty plus" th:data-goods-num="${dto.goodsDTO.goodsNum}" th:data-goods-price="${dto.goodsDTO.goodsPrice}" onclick="handleQty('plus', this)">+</button>
                      </div>
                    </td>
                    <td class="td-total">
                      <span class="total-price" th:id="${'t_' + dto.goodsDTO.goodsNum}">
                        [[${#numbers.formatCurrency(dto.goodsDTO.goodsPrice * dto.cartDTO.cartQty)}]]
                      </span>원
                    </td>
                    <td class="td-manage">
                      <a class="btn-delete" th:href="|javascript:deleteItem('${dto.goodsDTO.goodsNum}')|">삭제</a>
                    </td>
                  </tr>
                </tbody>
              </table>
              
              <div class="cart-summary">
                  <div class="summary-group-left">
                      <div class="summary-item">
                        <span class="label">총 선택 상품:</span>
                        <span class="value" id="totalItemCount">0개</span>
                      </div>
                      <div class="summary-item">
                        <span class="label">총 수량:</span>
                        <span class="value" id="totalItemQty">0개</span>
                      </div>
                  </div>
                  <div class="summary-group-right">
                      <div class="summary-item">
                        <span class="label">총 상품 금액:</span>
                        <span class="value price" id="totalPrice">0원</span>
                      </div>
                      <button type="submit" class="btn-purchase">구매하기</button>
                  </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
</div>
<th:block layout:fragment="script">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
    // [수정] 이 함수를 통째로 교체하세요
    function calculateTotals() {
        let checkedItemCount = 0;
        let totalQuantity = 0; // 총 수량을 위한 변수 추가
        let totalPrice = 0;
        
        $('input.item-check:checked').each(function() {
            checkedItemCount++;
            const row = $(this).closest('tr');
            
            // 현재 상품의 수량 가져오기
            const qtyText = row.find('.qty-display').text();
            if(qtyText) {
                totalQuantity += parseInt(qtyText);
            }

            // 현재 상품의 합계 금액 가져오기
            const priceText = row.find('.total-price').text().replace(/[^0-9]/g, '');
            if (priceText) {
                totalPrice += parseInt(priceText);
            }
        });

        $('#totalItemCount').text(checkedItemCount.toLocaleString() + '개');
        $('#totalItemQty').text(totalQuantity.toLocaleString() + '개'); // 총 수량 업데이트
        $('#totalPrice').text(totalPrice.toLocaleString() + '원');
    }

        function handleQty(action, button) {
            const goodsNum = $(button).data('goods-num');
            const goodsPrice = $(button).data('goods-price');
            const qtyElement = $('#' + goodsNum);
            let currentQty = parseInt(qtyElement.text());

            if (action === 'minus') {
                if (currentQty <= 1) {
                    alert('최소 수량은 1개입니다.');
                    return;
                }
                currentQty--;
                $.get('/cart/cartQtyDown?goodsNum=' + goodsNum);
            } else if (action === 'plus') {
                currentQty++;
                 $.ajax({
                    type: "post",
                    url: "/cart/cartAdd",
                    contentType: "application/json",
                    data: JSON.stringify({ goodsNum: goodsNum, qty: 1 })
                });
            }
            
            qtyElement.text(currentQty);
            const newTotalPrice = currentQty * parseInt(goodsPrice);
            $('#t_' + goodsNum).text(newTotalPrice.toLocaleString());
            
            calculateTotals();
        }
        
        function deleteItem(goodsNum) {
            if (confirm('이 상품을 장바구니에서 삭제하시겠습니까?')) {
                location.href = '/cart/cartDel?goodsNums=' + goodsNum;
            }
        }

        function deleteSelectedItems() {
            const checkedItems = $('input.item-check:checked');
            if (checkedItems.length === 0) {
                alert('삭제할 상품을 선택해주세요.');
                return;
            }

            if (confirm('선택한 ' + checkedItems.length + '개의 상품을 삭제하시겠습니까?')) {
                const goodsNums = checkedItems.map(function() { return $(this).val(); }).get();
                $.ajax({
                    type: "POST",
                    url: "/cart/cartDels",
                    contentType: "application/json",
                    data: JSON.stringify(goodsNums),
                    success: function(response) {
                        if (response === "200") {
                            location.reload();
                        } else {
                            alert("삭제에 실패했습니다. 다시 시도해주세요.");
                        }
                    },
                    error: function() {
                        alert("오류가 발생했습니다. 다시 시도해주세요.");
                    }
                });
            }
        }
        
        function deleteAllItems() {
            if ($('.cart-item').length === 0) {
                alert('장바구니가 이미 비어있습니다.');
                return;
            }
            if (confirm('장바구니의 모든 상품을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                $.ajax({
                    type: "POST",
                    url: "/cart/cartDelAll",
                    success: function(response) {
                        if (response === "200") {
                            location.reload();
                        } else {
                            alert("전체 삭제에 실패했습니다.");
                        }
                    },
                    error: function() {
                        alert("오류가 발생했습니다.");
                    }
                });
            }
        }

        $(document).ready(function() {
            $('#checkAll, .item-check').on('change', function() {
                if ($(this).is('#checkAll')) {
                    $('.item-check').prop('checked', $(this).prop('checked'));
                } else {
                    if ($('.item-check:checked').length === $('.item-check').length) {
                        $('#checkAll').prop('checked', true);
                    } else {
                        $('#checkAll').prop('checked', false);
                    }
                }
                calculateTotals();
            });
            calculateTotals();
        });
    </script>
</th:block>
</html>