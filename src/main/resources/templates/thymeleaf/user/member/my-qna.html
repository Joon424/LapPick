<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{../layout/default}">
<head>
    <title>나의 상품 문의</title>
    
<th:block layout:fragment="css">
  <style>
        .qna-table { table-layout: fixed; border-collapse: collapse; width: 100%; }
        .qna-table th, .qna-table td { vertical-align: middle; padding: 12px 10px; border-bottom: 1px solid #e5e7eb; }
        .qna-table thead { background-color: #f9fafb; }
        .qna-table th,
        .qna-table .qna-title-row > td { text-align: center; }
        .qna-title-row { cursor: pointer; }
        .qna-title-row:hover { background-color: #f5f5f5; }

        .status-badge { display: inline-block; padding: 4px 10px; font-size: 12px; border-radius: 12px; color: #fff; }
        .status-badge.waiting { background-color: #dc3545; }
        .status-badge.completed { background-color: #007bff; }

        .qna-content-row { display: none; }
        .qna-content-cell {
            padding: 25px 15px !important;
            text-align: left; background-color: #f8f9fa;
            line-height: 1.6; border-left: 3px solid #dee2e6;
        }
        .qna-box, .answer-box { display: flex; gap: 20px; align-items: flex-start; }
        .answer-box { margin-top: 25px; padding-top: 25px; border-top: 1px dashed #ced4da; }
        .qa-icon { flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: #fff; }
        .qa-icon.question { background-color: #495057; }
        .qa-icon.answer { background-color: #0056b3; }
        .qa-main { flex-grow: 1; }
        .qa-meta { font-size: 14px; color: #6c757d; margin-bottom: 12px; }
        .qa-meta .author { font-weight: 600; color: #343a40; }
        .qa-text { font-size: 16px; white-space: pre-wrap; margin: 0; color: #212529; }
        
        .pagination-container .page-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px; 
            height: 32px;
            padding: 0; 
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            color: #555;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            box-sizing: border-box;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .page-btn:not(.active):not(.disabled):hover {
            background-color: #f0f0f0;
            border-color: #bbb;
        }
        .pagination-container .page-btn.active {
            background-color: #333;
            color: #fff;
            border-color: #333;
            font-weight: bold;
            cursor: default;
        }
        .pagination-container .page-btn.disabled {
            color: #bbb;
            border-color: #e0e0e0;
            cursor: default;
            background-color: #f9f9f9;
            pointer-events: none;
        }
        .pagination-container .page-btn.disabled:hover {
             background-color: #f9f9f9;
             border-color: #e0e0e0;
        }
        
            .modal-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.6);
                justify-content: center;
                align-items: center;
                z-index: 1000;
            }
            .modal-content {
                background-color: #fff;
                padding: 25px 30px;
                border-radius: 8px;
                width: 90%;
                max-width: 680px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            }
            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
            }
            .modal-header h3 {
                font-size: 1.6rem;
                font-weight: 600;
                margin: 0;
            }
            .close-btn {
                font-size: 2rem;
                font-weight: bold;
                color: #888;
                cursor: pointer;
                border: none;
                background: none;
            }
            .form-table {
                table-layout: fixed;
                border-collapse: collapse;
                width: 100%;
                border-top: 2px solid #333;
            }
            .form-table th, .form-table td {
                border-bottom:1px solid #e5e7eb;
                padding:12px 15px;
                vertical-align: top;
            }
            .form-table th {
                width:150px;
                background:#fafafa;
                text-align:left;
                font-weight: 600;
            }
            .form-table input[type="text"], .form-table select, .form-table textarea {
              width:100%;
              box-sizing:border-box;
              padding:8px;
              border:1px solid #d1d5db;
              border-radius:6px;
              font-size:14px;
            }
            .form-table textarea {
                resize: vertical;
                min-height: 150px;
            }
            .btn-bar {
                display:flex;
                align-items:center;
                gap:10px;
                margin-top:16px;
                justify-content:flex-end;
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="basic-N23" data-bid="wWM47SwZLN">
        <div class="contents-inner">
            <div class="contents-container container-md">
                <div class="textset" style="margin-bottom:14px;">
                    <img class="imageset-img" src="/resources/images/img_basic_N23_1.png" alt="나의 상품 문의 헤더 이미지">
                    <h2 class="textset-tit">나의 상품 문의</h2>
                    <p class="textset-desc">작성하신 상품 문의 내역을 확인하고, 새로운 문의를 작성할 수 있습니다.</p>
                </div>
                
                <div th:if="${message}" th:text="${message}" class="alert" style="background:#e0f7fa;color:#00796b;border:1px solid #b2ebf2;padding:10px 12px;border-radius:6px;margin:10px 0;"></div>
                <div th:if="${error}" th:text="${error}" class="alert" style="background:#ffebee;color:#c62828;border:1px solid #ef9a9a;padding:10px 12px;border-radius:6px;margin:10px 0;"></div>
                <div th:if="${deleteMessage}" th:text="${deleteMessage}" class="alert" style="background:#ffebee;color:#c62828;border:1px solid #ef9a9a;padding:10px 12px;border-radius:6px;margin:10px 0;"></div>
                <div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:10px 0 16px;">
                  <form th:action="@{/qna/my-qna}" method="get" style="display:flex; gap:8px; align-items:center;">
                        <select name="status" onchange="this.form.submit()" style="height:36px; padding:0 10px; border:1px solid #cbd5e1; border-radius:6px;">
                            <option value="">전체 상태</option>
                            <option value="답변대기" th:selected="${status == '답변대기'}">답변대기</option>
                            <option value="답변완료" th:selected="${status == '답변완료'}">답변완료</option>
                        </select>
                        <input type="text" name="searchWord" th:value="${pageData?.searchWord}" placeholder="제목으로 검색" style="height:36px; padding:0 10px; border:1px solid #cbd5e1; border-radius:6px; min-width:240px;">
                        <button type="submit" class="btnset btnset-line btnset-round">검색</button>
                     <a class="btnset btnset-line btnset-round" th:href="@{/qna/my-qna}">전체보기</a>
                    </form>
                    <div>
                        <button type="button" class="btnset btnset-round" onclick="openQnaModal()">문의 등록</button>
                    </div>
                </div>

                <table class="qna-table">
                    <thead>
                        <tr>
                            <th style="width:10%;">상태</th>
                            <th style="width:15%;">유형</th>
                            <th style="width:25%;">상품명</th>
                            <th style="width:35%;">제목</th>
                            <th style="width:15%;">작성일</th>
                        </tr>
                    </thead>
                    <tbody th:if="${pageData == null or #lists.isEmpty(pageData.items)}">
                        <tr><td colspan="5" style="padding:40px 0;">등록된 문의가 없습니다.</td></tr>
                    </tbody>
<tbody th:unless="${pageData == null or #lists.isEmpty(pageData.items)}">
    <th:block th:each="qna : ${pageData.items}">
        <tr class="qna-title-row" th:data-qna-num="${qna.qnaNum}">
            <td>
                <span th:text="${qna.qnaStatus}" class="status-badge"
                      th:classappend="${qna.qnaStatus == '답변대기'} ? 'waiting' : 'completed'"></span>
            </td>
            <td th:text="${qna.qnaType}"></td>
            <td th:text="${qna.goodsName}"></td>
            <td th:text="${qna.qnaTitle}"></td>
            <td th:text="${#temporals.format(qna.qnaDate, 'yyyy-MM-dd')}"></td>
        </tr>
        <tr class="qna-content-row" th:id="'qna-content-' + ${qna.qnaNum}">
            <td colspan="5" class="qna-content-cell">
                <div class="qna-box">
                    <div class="qa-icon question">Q</div>
                    <div class="qa-main">
                        <div class="qa-meta">
                            <span class="author" th:text="${qna.memberId}"></span>
                            <span class="date" th:text="${#temporals.format(qna.qnaDate, 'yyyy.MM.dd HH:mm')}"></span>
                        </div>
                        <p class="qa-text" th:text="${qna.qnaContent}"></p>
                    </div>
                </div>
                <div class="answer-box" th:if="${qna.answerContent != null}">
                    <div class="qa-icon answer">A</div>
                    <div class="qa-main">
                        <div class="qa-meta">
                            <span class="author">LapPick 답변</span>
                            <span class="date" th:text="${#temporals.format(qna.answerDate, 'yyyy.MM.dd HH:mm')}"></span>
                        </div>
                        <p class="qa-text" th:text="${qna.answerContent}"></p>
                    </div>
                </div>
            </td>
        </tr>
    </th:block>
</tbody>
                </table>
                
                <div id="qnaModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>새 문의 작성</h3>
            <button type="button" class="close-btn" onclick="closeQnaModal()">×</button>
        </div>
       <form action="/qna/write" method="post" th:object="${qnaWriteRequest}"> <table class="form-table">
        <tr>
            <th>문의 상품</th>
            <td>
                <select name="purchaseItemKey" required th:field="*{purchaseItemKey}">
                    <option value="">-- 문의할 주문 상품을 선택하세요 --</option>
                    <option th:each="item : ${purchaseList}"
                            th:value="|${item.purchaseNum}-${item.goodsNum}|"
                            th:text="|${item.goods.goodsName} (구매일: ${#dates.format(item.purchaseDate, 'yyyy-MM-dd')})|"
                            th:selected="${param.goodsNum != null and item.goodsNum == param.goodsNum[0]}"></option>
                </select>
                <div th:if="${#fields.hasErrors('purchaseItemKey')}" th:errors="*{purchaseItemKey}" style="color:red; font-size:12px;"></div>
            </td>
        </tr>
        <tr>
            <th>문의 유형</th>
            <td>
                <select name="qnaType" required th:field="*{qnaType}">
                    <option value="상품">상품</option>
                    <option value="배송">배송</option>
                    <option value="교환/반품">교환/반품</option>
                    <option value="기타">기타</option>
                </select>
                 <div th:if="${#fields.hasErrors('qnaType')}" th:errors="*{qnaType}" style="color:red; font-size:12px;"></div>
            </td>
        </tr>
        <tr>
            <th>제목</th>
            <td>
                <input type="text" name="qnaTitle" required th:field="*{qnaTitle}">
                 <div th:if="${#fields.hasErrors('qnaTitle')}" th:errors="*{qnaTitle}" style="color:red; font-size:12px;"></div>
            </td>
        </tr>
        <tr>
            <th>내용</th>
            <td>
                <textarea name="qnaContent" rows="8" required th:field="*{qnaContent}"></textarea>
                 <div th:if="${#fields.hasErrors('qnaContent')}" th:errors="*{qnaContent}" style="color:red; font-size:12px;"></div>
            </td>
        </tr>
    </table>
    <div class="btn-bar">
        <button type="button" class="btnset btnset-line" onclick="closeQnaModal()">취소</button>
        <button type="submit" class="btnset">문의 등록</button>
    </div>
</form>
    </div>
</div>

               <div class="pagination-container" style="display:flex; gap:6px; justify-content:center; align-items:center; margin-top:20px;"
                    th:if="${pageData != null and pageData.total > 0}">
                   
                   <a class="page-btn"
                      th:href="${pageData.page > 1} ? @{/qna/my-qna(page=1, searchWord=${pageData.searchWord}, status=${status})} : null"
                      th:classappend="${pageData.page <= 1} ? 'disabled' : ''">&lt;&lt;</a>
                   
                   <a class="page-btn"
                      th:href="${pageData.page > 1} ? @{/qna/my-qna(page=${pageData.page - 1}, searchWord=${pageData.searchWord}, status=${status})} : null"
                      th:classappend="${pageData.page <= 1} ? 'disabled' : ''">&lt;</a>
                   
                   <a class="page-btn" th:each="p : ${#numbers.sequence(pageData.startPage, pageData.endPage)}" th:text="${p}"
                      th:classappend="${pageData.page == p} ? 'active' : ''"
                      th:href="@{/qna/my-qna(page=${p}, searchWord=${pageData.searchWord}, status=${status})}"></a>
                   
                   <a class="page-btn"
                      th:href="${pageData.page < pageData.totalPages} ? @{/qna/my-qna(page=${pageData.page + 1}, searchWord=${pageData.searchWord}, status=${status})} : null"
                      th:classappend="${pageData.page >= pageData.totalPages} ? 'disabled' : ''">&gt;</a>
                   
                   <a class="page-btn"
                      th:href="${pageData.page < pageData.totalPages} ? @{/qna/my-qna(page=${pageData.totalPages}, searchWord=${pageData.searchWord}, status=${status})} : null"
                      th:classappend="${pageData.page >= pageData.totalPages} ? 'disabled' : ''">&gt;&gt;</a>
               </div>
        </div>
    </div>
    
    </div>
<th:block layout:fragment="script">
<script th:inline="javascript">
    /*<![CDATA[*/
    const validationError = /*[[${validationError}]]*/ false;
    /*]]>*/

    const qnaModal = document.getElementById('qnaModal');
    function openQnaModal() { 
        if(qnaModal) qnaModal.style.display = 'flex'; 
    }
    function closeQnaModal() { 
        if(qnaModal) qnaModal.style.display = 'none'; 
    }
    window.onclick = function(event) { 
        if (event.target == qnaModal) { 
            closeQnaModal(); 
        } 
    }

    document.addEventListener('DOMContentLoaded', function() {
        
        if (validationError) {
            openQnaModal();
        }

        // 아코디언 UI가 빠르게 반복 클릭될 때 깨지는 현상(레이스 컨디션)을 방지합니다.
        let isAccordionBusy = false; 

        const qnaRows = document.querySelectorAll('.qna-title-row');
        
        qnaRows.forEach(row => {
            row.addEventListener('click', function() {
                
                // 처리가 진행 중이면(true) 이 클릭은 무시합니다.
                if (isAccordionBusy) return; 
                isAccordionBusy = true; // 처리 시작 (플래그 잠금)
                
                const qnaNum = this.dataset.qnaNum;
                const targetContentRow = document.getElementById('qna-content-' + qnaNum);
                
                if (!targetContentRow) {
                    isAccordionBusy = false; // 대상이 없으면 플래그 해제
                    return;
                }

                const openContentRow = document.querySelector('.qna-content-row[style*="table-row"]');
                const isTargetAlreadyOpen = (targetContentRow === openContentRow);

                if (openContentRow) {
                    openContentRow.style.display = 'none';
                }

                if (!isTargetAlreadyOpen) {
                    targetContentRow.style.display = 'table-row';
                }
                
                // DOM 업데이트 보장을 위해 짧은 지연 후 플래그를 해제합니다.
                setTimeout(() => {
                    isAccordionBusy = false;
                }, 10);
            });
        });
    });
</script>
</th:block>
</body>
</html>