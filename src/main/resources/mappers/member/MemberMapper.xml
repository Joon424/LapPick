<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
        "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lappick.member.mapper.MemberMapper">

    <sql id="memberColumns">
        MEMBER_NUM, MEMBER_NAME, MEMBER_ID, MEMBER_PW, MEMBER_ADDR,
        MEMBER_ADDR_DETAIL, MEMBER_POST, MEMBER_REGIST, GENDER,
        MEMBER_PHONE1, MEMBER_PHONE2, MEMBER_EMAIL, MEMBER_BIRTH,
        MEMBER_POINT, MEMBER_EMAIL_CONF
    </sql>

    <select id="memberSelectList" parameterType="lappick.domain.StartEndPageDTO" resultType="lappick.member.dto.MemberResponse">
        SELECT * FROM (
            SELECT ROW_NUMBER() OVER (ORDER BY member_regist DESC) AS rn, <include refid="memberColumns" />
            FROM members
            <where>
                <if test="searchWord != null and searchWord != ''">
                    (LOWER(MEMBER_NAME) LIKE '%' || LOWER(#{searchWord}) || '%' OR LOWER(MEMBER_ID) LIKE '%' || LOWER(#{searchWord}) || '%')
                </if>
            </where>
        )
        WHERE rn BETWEEN #{startRow} AND #{endRow}
    </select>

    <select id="memberCountBySearch" resultType="int">
        SELECT COUNT(*) FROM members
        <where>
            <if test="searchWord != null and searchWord != ''">
                (LOWER(MEMBER_NAME) LIKE '%' || LOWER(#{searchWord}) || '%' OR LOWER(MEMBER_ID) LIKE '%' || LOWER(#{searchWord}) || '%')
            </if>
        </where>
    </select>

    <select id="memberSelectOneByNum" parameterType="string" resultType="lappick.member.dto.MemberResponse">
        SELECT <include refid="memberColumns" />
        FROM members
        WHERE member_num = #{memberNum}
    </select>
    
    <delete id="memberDelete" parameterType="list">
        DELETE FROM members
        WHERE member_num IN
        <foreach collection="list" item="num" open="(" separator="," close=")">
            #{num}
        </foreach>
    </delete>

    <select id="selectMemberById" parameterType="string" resultType="lappick.member.dto.MemberResponse">
        SELECT <include refid="memberColumns" />
        FROM members
        WHERE member_id = #{memberId}
    </select>
    
    <update id="memberUpdate" parameterType="lappick.member.dto.MemberResponse">
        UPDATE members
        SET
            MEMBER_NAME        = #{memberName},
            MEMBER_ADDR        = #{memberAddr},
            MEMBER_ADDR_DETAIL = #{memberAddrDetail, jdbcType=VARCHAR},
            MEMBER_POST        = #{memberPost},
            MEMBER_PHONE1      = #{memberPhone1},
            MEMBER_PHONE2      = #{memberPhone2, jdbcType=VARCHAR},
            MEMBER_EMAIL       = #{memberEmail},
            MEMBER_BIRTH       = #{memberBirth}
        WHERE MEMBER_ID        = #{memberId}
    </update>

    <update id="memberPwUpdate" parameterType="lappick.member.dto.MemberResponse">
        UPDATE members
        SET member_pw = #{memberPw}
        WHERE member_id = #{memberId}
    </update>

    <select id="selectPwById" parameterType="string" resultType="string">
        SELECT member_pw
        FROM members
        WHERE member_id = #{memberId}
    </select>
    
    <delete id="deleteMemberById" parameterType="string">
        DELETE FROM members 
        WHERE member_id = #{memberId}
    </delete>
    
    <select id="findIdByNameAndEmail" resultType="string">
        SELECT MEMBER_ID
        FROM MEMBERS
        WHERE MEMBER_NAME = #{memberName} AND MEMBER_EMAIL = #{memberEmail}
    </select>

    <select id="findByIdAndEmail" resultType="lappick.member.dto.MemberResponse">
        SELECT <include refid="memberColumns" />
        FROM MEMBERS
        WHERE MEMBER_ID = #{memberId} AND MEMBER_EMAIL = #{memberEmail}
    </select>

    <select id="memberNumSelect" parameterType="string" resultType="string">
        SELECT member_num FROM members WHERE member_id = #{memberId}
    </select>

    <select id="selectOneById" parameterType="string" resultType="lappick.member.dto.MemberResponse">
        SELECT <include refid="memberColumns" />
        FROM MEMBERS
        WHERE MEMBER_ID = #{memberId}
    </select>
</mapper>