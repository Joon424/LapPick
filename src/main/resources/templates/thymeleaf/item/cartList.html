<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="imagetoolbar" content="no">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="format-detection" content="telephone=no">
  <meta name="title" content="웹사이트">
  <meta name="description" content="웹사이트입니다.">
  <meta name="keywords" content="키워드,키워드,키워드">
  <meta property="og:title" content="웹사이트">
  <meta property="og:description" content="웹사이트입니다">
  <meta property="og:image" content="https://웹사이트/images/opengraph.png">
  <meta property="og:url" content="https://웹사이트">
  <title>장바구니 | Miso</title>
  <link rel="stylesheet"  href="/resources/css/setting.css">
  <link rel="stylesheet"  href="/resources/css/plugin.css">
  <link rel="stylesheet"  href="/resources/css/template.css">
  <link rel="stylesheet"  href="/resources/css/common.css">
  <link rel="stylesheet"  href="/resources/css/style.css">
  <script src="/static/js/cartButton.js"></script>
 <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.1.min.js"></script>
<script type="text/javascript" src="/static/js/checkbox.js"></script>
<script type="text/javascript" src="/static/js/money.js"></script>
<script type="text/javascript">
function cartAdd(goodsNum , goodsPrice){
	var stringNumber = $("#"+goodsNum).text();  // 1,000
	var number = Number(stringNumber.replace(/,/g, '')); // 1000
	number += 1;
	const commaNumber = number.toLocaleString(); // 1,001
	
	var formData = JSON.stringify({
		goodsNum : goodsNum,
		qty : 1
	});

	option = {
		type: "post",
		url: "/item/cartAdd",
		contentType: "application/json",
		data:formData,
		success :  function(result){ // w1,000,000
			var price = $("#t_"+goodsNum).text().substring(1).replace(/,/g, "");
			console.log(price); // 100000
			if(result == 200){
				$("#"+goodsNum).text(commaNumber); // 수량  1000 + 1
				price = Number(price) + parseInt(goodsPrice);     // 	1000
				$("#t_"+goodsNum).text(formatter.format(price));
			}
		},
		error : err ,
		complete : prodChk
	};
	$.ajax(option);
}
function prodChk(){
	var chkLeng  = $('input[name="nums"]')
	var cnt = 0; // 상품 수
	var totalQty = 0; // 총 상품의 갯수
	var totalPrice = 0; // 총 상품 금액
	for(var i = 0; i < chkLeng.length ; i++){
		if(chkLeng[i].checked){
			cnt ++;
			var stringQty = $(".cartQty:eq("+i+")").text();  // 1,000
			var number = Number(stringQty.replace(/,/g, '')); // 1000
			totalQty += Number(number);
			
			var price = $(".totalPrice:eq("+i+")").text().substring(1).replace(/,/g,"");
			totalPrice += Number(price);		
		}
	}
	var commaQty = totalQty.toLocaleString(); // 1,001
	$("#prodCnt").text(cnt);
	$("#totQty").text(commaQty);
	$("#totalPrice").text(formatter.format(totalPrice));
}
function err(){
	alert("로그 아웃되었습니다. 다시로그인 해주세요.");
	window.open("loginCk.login","loginck","width=400,height=400");
}
function checkQty(goodsNum, goodsPrice){
	var stringNumber = $("#"+goodsNum).text();
	var number = Number(stringNumber.replace(/,/g, ''));
	if(number > 1){
		number = number - 1;
		const commaNumber = number.toLocaleString();
		var xhr = new XMLHttpRequest();
		xhr.onload = function(){
			if(xhr.status==200){
				var price = $("#t_"+goodsNum).text().substring(1).replace(/,/g, "");
				$("#"+goodsNum).text(commaNumber);
				price = Number(price) - parseInt(goodsPrice);
				$("#t_"+goodsNum).text(formatter.format(price));
				prodChk();
			}
		}
		xhr.open("GET","cartQtyDown?goodsNum="+goodsNum, true);
		xhr.send();
	}else{
		alert("최소 수량은 1이어야 합니다.");
	}	
}
function del1(){
	var chk_arr = [];
	$("input:checkbox[name='nums']:checked").each(function(){
		chk_arr.push($(this).val());
	});
	/*
		$.ajax({
			type:,
			url:,
			data:formData,
			contentType:"application/json",
			dataType:,
			success:function(result){},
			error:
		});
	*/
	var xhr = new XMLHttpRequest();
	xhr.open("POST","cartDels",true);
	xhr.setRequestHeader("Content-Type", "application/json");
	var formData = JSON.stringify(chk_arr);
	xhr.onload = function(){
		if(xhr.status == 200){
			var result = xhr.responseText;
			if(result == "200") location.reload(); // CSR을 할 필요 없다.. SSR을 권장
			else alert("삭제되지 않았습니다.");
			
		}else{
			alert("삭제되지 않았습니다.");
		}
	}
	xhr.send(formData);
}
</script>
</head>

<body>
  <!-- [S]basic-N3 -->
  <div class="basic-N3" data-bid="fd11u4FG1BK">
    <div class="header-inner">
      <div class="header-container container-lg">
        <div class="header-left">
          <h1 class="header-title">
            <a href="/">
              <img  src="/resources/images/img_logo_black.png" alt="로고">
            </a>
          </h1>
          <div class="header-mobile-group">
            <div class="header-mobile-top">
              <p>로그인이 필요합니다.</p>
              <a href="javascript:void(0)">로그인</a>
            </div>
                      <ul class="header-gnblist">
              <li class="header-gnbitem">
                <a class="header-gnblink" href="/banner/brand">
                  <span>BRAND</span>
                </a>
              </li>
              <li class="header-gnbitem">
                <a class="header-gnblink" href="/goods/goodsFullList">
                  <span>PRODUCTS</span>
                </a>
              </li>
              <li class="header-gnbitem">
                <a class="header-gnblink" href="/banner/notice">
                  <span>NOTICE</span>
                </a>
              </li>
              <li class="header-gnbitem">
                <a class="header-gnblink" href="/banner/faq">
                  <span>FAQ</span>
                </a>
              </li>
          <li class="header-gnbitem">
  <a class="header-gnblink" 
     th:href="${isLoggedIn} ? '/login/logout' : '/login/item.login'">
    <span th:text="${isLoggedIn} ? 'LOGOUT' : 'LOGIN'"
          th:style="${isLoggedIn} ? 'color: red;' : ''">LOGIN</span>
  </a>
</li>

            </ul>
            <button class="header-btn btn-close">
              <img  src="/resources/icons/ico_close_white.svg" alt="닫기 아이콘">
            </button>
          </div>
        </div>
        <div class="header-right">
          <div class="header-utils">
            <button class="header-btn btn-seach">
              <img  src="/resources/icons/ico_seach_black.svg" alt="검색 아이콘">
            </button>
            <a href="/login/userIcon" class="header-btn btn-user" id="user-icon">
              <img  src="/resources/icons/ico_user_black.svg" alt="유저 아이콘">
            </a>
            <button class="header-btn btn-cart badgeset badgeset-circle badgeset-position badgeset-bottom-right">
              <img  src="/resources/icons/ico_cart_black.svg" alt="쇼핑백 아이콘">
              <span class="badgeset-text">1</span>
            </button>
            <button class="header-btn btn-allmenu">
              <img  src="/resources/icons/ico_menu2_black.svg" alt="PC메뉴 아이콘">
            </button>
            <button class="header-btn btn-momenu">
              <img  src="/resources/icons/ico_menu2_black.svg" alt="모바일메뉴 아이콘">
            </button>
            <button class="header-btn btn-close">
              <img  src="/resources/icons/ico_close_black.svg" alt="닫기 아이콘">
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="header-dim"></div>
  </div>
  <!-- [E]basic-N3 -->
  <main class="th-layout-main ">
    <!-- [S]basic-N23 -->
    <div class="basic-N23" data-bid="Zk2czu8Wyib" id="">
      <div class="contents-inner">
        <div class="contents-container container-md">
          <div class="textset">
            <img class="imageset-img"  src="/resources/images/img_basic_N23_1.png" alt="이미지" th-hoverbox="true">
            <h2 class="textset-tit">장바구니</h2>
            <p class="textset-desc"> 여기서 선택하신 상품들을 한눈에 확인하실 수 있습니다. 상품 수량을 조정하거나, 필요하지 않은 상품을 삭제할 수 있으며,<br> 원하시는 모든 상품을 편리하게 구매할 수 있습니다. 모든 상품을 확인하신 후,   [구매하기] 버튼을 클릭하여 안전하게 결제를 진행해 주세요. </p>
          </div>
          
              <!-- [장바구니 테이블] -->
          <div class="cart-list">
            <h2>장바구니 목록</h2>
            <br/>
            <form action="/purchase/goodsBuy" method="post">
              <table width="1200" align="center">
                <tr>
                  <td><input type="checkbox" id="checkBoxs" checked="checked" /></td>
                  <td>이미지</td>
                  <td>제품명</td>
                  <td>수량</td>
                  <td>합계금액</td>
                  <td><input type="button" value="선택 상품 삭제" onclick="del1();" /></td>
                </tr>

                <!-- 상품 리스트 (전 프로젝트 코드에서 반복문) -->
                <tr th:each="dto : ${list}">
                  <td><input type="checkbox" name="nums" checked="checked" th:value="${dto.goodsDTO.goodsNum}" /></td>
                  <td><img th:src="|/static/upload/${dto.goodsDTO.goodsMainStoreImage}|" width="50" /></td>
                  <td>[[${dto.goodsDTO.goodsName}]]</td>
                  <td>
                    <a th:href="|javascript:checkQty('${dto.goodsDTO.goodsNum}','${dto.goodsDTO.goodsPrice}');|"> - </a>
                    <span th:id="${dto.goodsDTO.goodsNum}" class="cartQty">[[${#numbers.formatInteger(dto.cartDTO.cartQty, 1, 'COMMA')}]]</span>개
                    <a th:href="|javascript:cartAdd('${dto.goodsDTO.goodsNum}','${dto.goodsDTO.goodsPrice}');|"> + </a>
                  </td>
                  <td>
                    <span th:id="${'t_' + dto.goodsDTO.goodsNum}" class="totalPrice">[[${#numbers.formatCurrency(dto.goodsDTO.goodsPrice * dto.cartDTO.cartQty)}]]</span>원
                  </td>
                  <td><input type="button" value="삭제" th:attr="onclick=|javascript:location.href='cartDel?goodsNums=${dto.goodsDTO.goodsNum}'|"/></td>
                </tr>

                <!-- 총합 -->
                <tr>
                  <td colspan="6" align="right">
                    상품수: <span id="prodCnt">[[${#numbers.formatInteger(list.size(), 1, 'COMMA')}]]</span>개<br />
                    총수량: <span id="totQty">[[${#numbers.formatInteger(totQty, 1, 'COMMA')}]]</span>개<br />
                    전체 합계: <span id="totalPrice">[[${#numbers.formatCurrency(totPri)}]]</span>원
                  </td>
                </tr>
                <tr>
                  <td colspan="6" align="right">
                    <input type="submit" value="구매하기" />
                  </td>
                </tr>
              </table>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- [E]basic-N23 -->
          
        
  </main>
  <!-- [S]basic-N4 -->
  <div class="basic-N4" data-bid="gy4JLDa15tK">
    <div class="footer-inner">
      <div class="footer-container container-lg">
        <div class="footer-top">
          <h1 class="footer-logo">
            <a href="javascript:void(0)">
              <img  src="/resources/images/img_logo_lightgray.png" alt="로고">
            </a>
          </h1>
   <ul class="footer-menulist">
            <li class="footer-menuitem">
              <a href="javascript:void(0)">
                <span>이용약관</span>
              </a>
            </li>
            <li class="footer-menuitem">
              <a href="javascript:void(0)">
                <span>개인정보처리방침</span>
              </a>
            </li>
            <li class="footer-menuitem">
              <a href="javascript:void(0)">
                <span>국비교육</span>
              </a>
            </li>
            <li class="footer-menuitem">
              <a href="javascript:void(0)">
                <span>미니프로젝트</span>
              </a>
            </li>
          </ul>
          <ul class="footer-snslist">
            <li class="footer-snsitem">
              <a class="footer-snslink" href="javascript:void(0)">
                <img  src="/resources/icons/ico_instagram_lightgrey.svg" alt="인스타그램">
              </a>
            </li>
            <li class="footer-snsitem">
              <a class="footer-snslink" href="javascript:void(0)">
                <img  src="/resources/icons/ico_youtube_lightgrey.svg" alt="유튜브">
              </a>
            </li>
            <li class="footer-snsitem">
              <a class="footer-snslink" href="javascript:void(0)">
                <img  src="/resources/icons/ico_facebook_lightgrey.svg" alt="페이스북">
              </a>
            </li>
            <li class="footer-snsitem">
              <a class="footer-snslink" href="javascript:void(0)">
                <img  src="/resources/icons/ico_kakao_lightgrey.svg" alt="카카오톡">
              </a>
            </li>
          </ul>
        </div>
         <div class="footer-bottom">
          <div class="footer-txt">
            <p> 성결대학교 성결관 301호 </p>
            <p>
              <span>T. 010-8246-6830</span>
              <span>E. wnflqm010203@sungkyul.ac.kr</span>
            </p>
          </div>
          <div class="footer-txt">
            <p>2024 BY JeongJunGyo. ALL RIGHTS RESEVED</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- [E]basic-N4 -->
  <script  src="/resources/js/setting.js"></script>
  <script  src="/resources/js/plugin.js"></script>
  <script  src="/resources/js/template.js"></script>
  <script  src="/resources/js/common.js"></script>
  <script  src="/resources/js/script.js"></script>
</body>
